<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ëª¨ë°”ì¼ ë§ˆì§„ ê³„ì‚°ê¸°</title>
  <!-- html5-qrcode ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #222;
      --sub: #666;
      --accent: #3a7afe;
      --ok: #12a150;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Noto Sans KR, sans-serif;
      background: var(--bg); color: var(--text);
    }
    .wrap { max-width: 680px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 1.25rem; margin: 14px 4px 10px; }
    .card {
      background: var(--card); border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.06); padding: 14px;
    }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 560px) { .row-2 { grid-template-columns: 1fr 1fr; } }

    label { font-size: .92rem; color: var(--sub); display: block; margin-bottom: 6px; }

    .field {
      display: flex; align-items: center; gap: 8px;
      border: 1px solid #e8e8ef; border-radius: 12px; padding: 10px 12px; background: #fff;
    }
    .field input, .field select {
      flex: 1; border: 0; outline: 0; font-size: 1.05rem; min-width: 0; background: transparent;
    }
    .addon { color: var(--sub); font-size: .95rem; white-space: nowrap; }

    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      height: 48px; padding: 0 16px; border: 0; border-radius: 12px;
      background: var(--accent); color: #fff; font-size: 1rem; font-weight: 600;
      width: 100%;
    }
    .btn.ghost { background: #eef3ff; color: var(--accent); }
    .btn.small { height: 40px; padding: 0 12px; font-size: .95rem; }

    .inline { display: flex; gap: 8px; align-items: center; }
    .grow { flex: 1; }
    .muted { color: var(--sub); font-size: .9rem; }

    .result {
      margin-top: 12px; padding: 12px; border-radius: 12px; background: #f3f7ff; border: 1px dashed #cfe0ff;
    }
    .price {
      font-size: 1.6rem; font-weight: 800; color: var(--ok);
    }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f1f1f5; border: 1px solid #e6e6ef; border-radius: 6px; padding: 2px 6px; }

    .footer { margin: 22px 4px 10px; color: var(--sub); font-size: .85rem; }

    /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab-btn { flex: 1; }
    .tab-btn.active { background: var(--accent); color: #fff; }
    .tab-btn:not(.active) { background: #eef3ff; color: var(--accent); }

    /* ë¬¼í’ˆ ê´€ë¦¬ */
    .item-card {
      background: #fff; border: 1px solid #e8e8ef; border-radius: 12px;
      padding: 12px; margin-bottom: 10px;
    }
    .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .item-name { font-size: 1.1rem; font-weight: 700; }
    .item-barcode { font-size: .85rem; color: var(--sub); font-family: monospace; }
    .item-detail { display: flex; gap: 12px; margin-top: 8px; font-size: .9rem; }
    .item-detail > div { flex: 1; }

    /* ìœ í†µê¸°í•œ ìƒíƒœ í‘œì‹œ */
    .expiry-badge {
      display: inline-block; padding: 4px 10px; border-radius: 8px;
      font-size: .85rem; font-weight: 600;
    }
    .expiry-expired { background: #ffe5e5; color: #d32f2f; }
    .expiry-warning { background: #fff3e0; color: #f57c00; }
    .expiry-caution { background: #fff9c4; color: #f9a825; }
    .expiry-ok { background: #e8f5e9; color: #388e3c; }

    .item-actions { display: flex; gap: 6px; margin-top: 10px; }
    .empty-state { text-align: center; padding: 40px 20px; color: var(--sub); }

    /* ë°”ì½”ë“œ ìŠ¤ìºë„ˆ */
    #scanner-container {
      margin: 12px 0;
      border-radius: 12px;
      overflow: hidden;
      display: none;
      background: #000;
    }
    #scanner-container.active {
      display: block;
    }
    #reader {
      width: 100%;
      border: none;
    }
    #reader video {
      width: 100%;
      border-radius: 12px;
    }
    .scanner-status {
      text-align: center;
      padding: 12px;
      background: #f3f7ff;
      border-radius: 8px;
      margin-top: 8px;
      font-size: .9rem;
      color: var(--accent);
    }

    /* ê²€ìƒ‰ í•˜ì´ë¼ì´íŠ¸ */
    .highlight {
      background-color: #fff59d;
      font-weight: 700;
      padding: 2px 0;
    }

    /* ì´ë¯¸ì§€ ê´€ë ¨ */
    .image-upload-container {
      margin: 12px 0;
    }
    .image-preview {
      width: 100%;
      max-width: 200px;
      height: 150px;
      border: 2px dashed #e8e8ef;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      overflow: hidden;
      background: #f9f9fb;
      position: relative;
    }
    .image-preview:hover {
      border-color: var(--accent);
      background: #f3f7ff;
    }
    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .image-preview-placeholder {
      text-align: center;
      color: var(--sub);
      font-size: 0.9rem;
    }
    .image-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .item-image {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      margin-right: 12px;
      border: 1px solid #e8e8ef;
    }

    /* ì¹´í…Œê³ ë¦¬ */
    .category-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      background: #e8e8ef;
      color: var(--text);
      margin-right: 4px;
    }
    .category-filter {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .category-chip {
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid #e8e8ef;
      background: white;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .category-chip:hover {
      border-color: var(--accent);
      background: #f3f7ff;
    }
    .category-chip.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“¦ ëª¨ë°”ì¼ ë§ˆì§„ ê³„ì‚°ê¸°</h1>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="tabs">
      <button class="btn tab-btn active" id="tabMargin" onclick="switchTab('margin')">ë§ˆì§„ ê³„ì‚°ê¸°</button>
      <button class="btn tab-btn" id="tabInventory" onclick="switchTab('inventory')">ë¬¼í’ˆ ê´€ë¦¬</button>
    </div>

    <!-- ë§ˆì§„ ê³„ì‚°ê¸° ì„¹ì…˜ -->
    <div id="sectionMargin" class="card">
      <div class="row row-2">
        <div>
          <label>ë°•ìŠ¤ êµ¬ì…ê°€(ì›)</label>
          <div class="field">
            <span class="addon">â‚©</span>
            <input id="boxCost" type="number" inputmode="decimal" placeholder="ì˜ˆ: 15000" />
          </div>
        </div>
        <div>
          <label>ë°•ìŠ¤ ìˆ˜ëŸ‰(ê°œ)</label>
          <div class="field">
            <input id="qty" type="number" inputmode="numeric" placeholder="ì˜ˆ: 24" />
            <span class="addon">ê°œ</span>
          </div>
        </div>
      </div>

      <div style="height: 10px"></div>

      <div class="row">
        <div>
          <label>ë§ˆì§„ìœ¨(%)</label>
          <div class="field">
            <input id="margin" type="number" inputmode="decimal" placeholder="ì˜ˆ: 30" />
            <span class="addon">%</span>
          </div>
        </div>
        <div>
          <label>ë°˜ì˜¬ë¦¼</label>
          <div class="field">
            <select id="rounding">
              <option value="1">1ì› ë‹¨ìœ„(ì •í™•)</option>
              <option value="10">10ì› ë‹¨ìœ„</option>
              <option value="50">50ì› ë‹¨ìœ„</option>
              <option value="100">100ì› ë‹¨ìœ„</option>
              <option value="ceil10">10ì› ì˜¬ë¦¼</option>
              <option value="ceil100">100ì› ì˜¬ë¦¼</option>
            </select>
          </div>
          <div class="muted">* í˜„ì¥ ë‹¨ê°€ë¥¼ ê¹”ë”í•˜ê²Œ ë§ì¶œ ë•Œ ìœ ìš©</div>
        </div>
      </div>

      <div style="height: 10px"></div>

      <div class="row">
        <button class="btn" type="button" onclick="calc()">ê³„ì‚°í•˜ê¸°</button>
      </div>

      <div id="result" class="result" style="display:none">
        <div class="inline">
          <div class="grow">
            <div class="muted">ê°œë‹¹ ì›ê°€</div>
            <div class="kbd" id="unitCost">-</div>
          </div>
          <div class="grow" style="text-align:right">
            <div class="muted">ê°œë‹¹ íŒë§¤ê°€</div>
            <div class="price" id="unitPrice">-</div>
          </div>
        </div>
        <div style="height: 10px"></div>
        <div class="grid-3">
          <button class="btn small ghost" type="button" onclick="copyPrice()">ê°€ê²© ë³µì‚¬</button>
          <button class="btn small ghost" type="button" onclick="sharePrice()">ê³µìœ </button>
          <button class="btn small ghost" type="button" onclick="resetAll()">ë¦¬ì…‹</button>
        </div>
        <div style="margin-top:10px" class="muted" id="detail"></div>
      </div>
    </div>

    <!-- ë¬¼í’ˆ ê´€ë¦¬ ì„¹ì…˜ -->
    <div id="sectionInventory" class="card" style="display:none">
      <h2 style="font-size: 1.1rem; margin: 0 0 14px;">ìƒˆ ë¬¼í’ˆ ë“±ë¡</h2>

      <div class="row">
        <div>
          <label>ë°”ì½”ë“œ ë²ˆí˜¸</label>
          <div class="field">
            <input id="invBarcode" type="text" inputmode="numeric" placeholder="ë°”ì½”ë“œ ì…ë ¥ ë˜ëŠ” ìŠ¤ìº”" />
          </div>
        </div>
      </div>

      <div style="height: 10px"></div>

      <div class="row">
        <button class="btn ghost" type="button" id="scanBtn" onclick="toggleScanner()">
          ğŸ“· ì¹´ë©”ë¼ë¡œ ë°”ì½”ë“œ ìŠ¤ìº”
        </button>
      </div>

      <!-- ë°”ì½”ë“œ ìŠ¤ìºë„ˆ -->
      <div id="scanner-container">
        <div id="reader"></div>
        <div class="scanner-status" id="scannerStatus">ì¹´ë©”ë¼ë¥¼ ë°”ì½”ë“œì— ë§ì¶°ì£¼ì„¸ìš”</div>
      </div>

      <div style="height: 10px"></div>

      <div class="row">
        <div>
          <label>ë¬¼í’ˆëª…</label>
          <div class="field">
            <input id="invName" type="text" placeholder="ì˜ˆ: ìš°ìœ " />
          </div>
        </div>
      </div>

      <div style="height: 10px"></div>

      <div class="row row-2">
        <div>
          <label>ìœ í†µê¸°í•œ</label>
          <div class="field">
            <input id="invExpiry" type="date" />
          </div>
        </div>
        <div>
          <label>ìˆ˜ëŸ‰</label>
          <div class="field">
            <input id="invQuantity" type="number" inputmode="numeric" placeholder="1" value="1" />
            <span class="addon">ê°œ</span>
          </div>
        </div>
      </div>

      <div style="height: 10px"></div>

      <div class="row row-2">
        <div>
          <label>ì¹´í…Œê³ ë¦¬</label>
          <div class="field">
            <select id="invCategory">
              <option value="">ì„ íƒ ì•ˆí•¨</option>
              <option value="ëƒ‰ì¥">ëƒ‰ì¥</option>
              <option value="ëƒ‰ë™">ëƒ‰ë™</option>
              <option value="ìƒì˜¨">ìƒì˜¨</option>
              <option value="ìŒë£Œ">ìŒë£Œ</option>
              <option value="ê³¼ì">ê³¼ì</option>
              <option value="ì‹ ì„ ì‹í’ˆ">ì‹ ì„ ì‹í’ˆ</option>
              <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>
          </div>
        </div>
        <div>
          <label>ê°€ê²© (ì„ íƒ)</label>
          <div class="field">
            <span class="addon">â‚©</span>
            <input id="invPrice" type="number" inputmode="decimal" placeholder="ì˜ˆ: 3000" />
          </div>
        </div>
      </div>

      <div style="height: 10px"></div>

      <div class="row">
        <div>
          <label>ë©”ëª¨ (ì„ íƒ)</label>
          <div class="field">
            <input id="invMemo" type="text" placeholder="ê°„ë‹¨ ë©”ëª¨" />
          </div>
        </div>
      </div>

      <div style="height: 10px"></div>

      <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
      <div class="row">
        <div>
          <label>ìƒí’ˆ ì‚¬ì§„ (ì„ íƒ)</label>
          <div class="image-upload-container">
            <input type="file" id="invImageCamera" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(event)" />
            <input type="file" id="invImageGallery" accept="image/*" style="display: none;" onchange="handleImageUpload(event)" />
            <div class="image-preview" id="imagePreview">
              <div class="image-preview-placeholder">
                ğŸ“·<br>ì‚¬ì§„ ì¶”ê°€<br>
                <span style="font-size: 0.75rem;">í´ë¦­í•˜ì—¬ ì„ íƒ</span>
              </div>
            </div>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 8px;">
            <button type="button" class="btn small ghost" onclick="openCamera()" style="flex: 1;">ğŸ“· ì¹´ë©”ë¼</button>
            <button type="button" class="btn small ghost" onclick="openGallery()" style="flex: 1;">ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬</button>
          </div>
        </div>
      </div>

      <div style="height: 12px"></div>

      <div class="row">
        <button class="btn" type="button" onclick="addItem()">ë¬¼í’ˆ ë“±ë¡</button>
      </div>

      <div style="height: 20px; border-top: 1px solid #e8e8ef; margin: 20px 0"></div>

      <div class="inline" style="margin-bottom: 12px;">
        <h2 style="font-size: 1.1rem; margin: 0; flex: 1;">ë¬¼í’ˆ ëª©ë¡</h2>
        <div class="muted" id="itemCount">0ê°œ</div>
      </div>

      <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
      <div class="category-filter" id="categoryFilter">
        <div class="category-chip active" data-category="" onclick="filterByCategory('')">ì „ì²´</div>
      </div>

      <!-- ê²€ìƒ‰ í•„í„° -->
      <div class="row" style="margin-bottom: 12px;">
        <div class="field">
          <span style="font-size: 1.1rem;">ğŸ”</span>
          <input id="searchInput" type="text" placeholder="ë¬¼í’ˆëª… ë˜ëŠ” ë°”ì½”ë“œë¡œ ê²€ìƒ‰..." oninput="searchItems()" />
        </div>
      </div>

      <div id="itemList">
        <div class="empty-state">
          ë“±ë¡ëœ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>
          <span class="muted" style="font-size: .85rem;">ìœ„ì—ì„œ ìƒˆ ë¬¼í’ˆì„ ë“±ë¡í•´ë³´ì„¸ìš”.</span>
        </div>
      </div>
    </div>

    <div class="footer">
      íŒ: í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ë©´ ì•±ì²˜ëŸ¼ ë¹ ë¥´ê²Œ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (Safari/Chrome â†’ "í™ˆ í™”ë©´ì— ì¶”ê°€")
    </div>
  </div>

  <script>
    const els = {
      boxCost: document.getElementById('boxCost'),
      qty: document.getElementById('qty'),
      margin: document.getElementById('margin'),
      rounding: document.getElementById('rounding'),
      result: document.getElementById('result'),
      unitCost: document.getElementById('unitCost'),
      unitPrice: document.getElementById('unitPrice'),
      detail: document.getElementById('detail'),
    };

    // ë¡œì»¬ ì €ì¥/ë³µì›
    (function restore() {
      try {
        const saved = JSON.parse(localStorage.getItem('marginCalcV2') || '{}');
        ['boxCost','qty','margin','rounding'].forEach(k => {
          if (saved[k] !== undefined && saved[k] !== null && saved[k] !== '') {
            els[k].value = saved[k];
          }
        });
        if (saved.boxCost || saved.qty || saved.margin) calc();
      } catch(_) {}
    })();

    function persist() {
      const data = {
        boxCost: els.boxCost.value,
        qty: els.qty.value,
        margin: els.margin.value,
        rounding: els.rounding.value
      };
      localStorage.setItem('marginCalcV2', JSON.stringify(data));
    }

    function roundBy(mode, value) {
      if (mode === 'ceil10') return Math.ceil(value / 10) * 10;
      if (mode === 'ceil100') return Math.ceil(value / 100) * 100;
      const step = parseInt(mode, 10) || 1; // 1,10,50,100
      return Math.round(value / step) * step;
    }

    function number(v) { return Number.isFinite(v) ? v : NaN; }

    function formatKRW(x, digits=0) {
      try { return Number(x).toLocaleString('ko-KR', { maximumFractionDigits: digits, minimumFractionDigits: digits }); }
      catch { return String(x); }
    }

    function calc() {
      const cost = number(parseFloat(els.boxCost.value));
      const qty = number(parseInt(els.qty.value, 10));
      const margin = number(parseFloat(els.margin.value));

      if (!Number.isFinite(cost) || !Number.isFinite(qty) || qty <= 0 || !Number.isFinite(margin)) {
        els.result.style.display = 'none';
        persist();
        return;
      }

      const unitCost = cost / qty;
      const unitPriceRaw = unitCost * (1 + margin / 100);
      const unitPriceRounded = roundBy(els.rounding.value, unitPriceRaw);

      els.unitCost.textContent = `${formatKRW(unitCost, 2)} ì›`;
      els.unitPrice.textContent = `â‚© ${formatKRW(unitPriceRounded)}`;

      els.detail.innerHTML =
        `ì›ê°€(ê°œë‹¹) ${formatKRW(unitCost,2)} Ã— (1 + ${margin.toFixed(2)}%) = `
        + `<span class="kbd">${formatKRW(unitPriceRaw,2)} ì›</span> â†’ `
        + `<span class="kbd">${els.rounding.options[els.rounding.selectedIndex].text}</span> ì ìš©`;

      els.result.style.display = 'block';
      persist();
    }

    function copyPrice() {
      const text = els.unitPrice.textContent.replace(/^â‚©\s*/, '');
      navigator.clipboard?.writeText(text).then(() => {
        toast('ë³µì‚¬ ì™„ë£Œ: ' + text + 'ì›');
      }).catch(() => alert('ë³µì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.'));
    }

    function sharePrice() {
      const cost = els.boxCost.value, qty = els.qty.value, mg = els.margin.value;
      const price = els.unitPrice.textContent;
      const msg = `ë§ˆì§„ ê³„ì‚° ê²°ê³¼\n- ë°•ìŠ¤: â‚©${cost} / ${qty}ê°œ\n- ë§ˆì§„: ${mg}%\n- ê°œë‹¹ íŒë§¤ê°€: ${price}`;
      if (navigator.share) {
        navigator.share({ title: 'ë§ˆì§„ ê³„ì‚° ê²°ê³¼', text: msg }).catch(()=>{});
      } else {
        alert(msg);
      }
    }

    function resetAll() {
      els.boxCost.value = '';
      els.qty.value = '';
      els.margin.value = '30';
      els.rounding.value = '10';
      els.result.style.display = 'none';
      persist();
    }

    // ê°„ë‹¨ í† ìŠ¤íŠ¸
    function toast(msg) {
      const t = document.createElement('div');
      t.textContent = msg;
      Object.assign(t.style, {
        position:'fixed', left:'50%', bottom:'24px', transform:'translateX(-50%)',
        background:'#111', color:'#fff', padding:'10px 14px', borderRadius:'10px',
        fontSize:'14px', opacity:'0', transition:'opacity .2s ease', zIndex:9999
      });
      document.body.appendChild(t);
      requestAnimationFrame(()=> t.style.opacity = '0.92');
      setTimeout(()=> {
        t.style.opacity='0';
        setTimeout(()=> t.remove(), 250);
      }, 1300);
    }

    // ì¦‰ì‹œ ë°˜ì‘í˜• ê³„ì‚°
    ['input','change'].forEach(ev=>{
      ['boxCost','qty','margin','rounding'].forEach(id=>{
        document.getElementById(id).addEventListener(ev, calc);
      });
    });

    // ê¸°ë³¸ê°’
    if (!els.margin.value) els.margin.value = 30;
    if (!els.rounding.value) els.rounding.value = '10';

    // ==================== ë¬¼í’ˆ ê´€ë¦¬ ê¸°ëŠ¥ ====================

    let inventory = [];
    let html5QrCode = null;
    let isScanning = false;
    let currentSearchTerm = '';
    let currentImageData = null;
    let currentCategoryFilter = '';

    // íƒ­ ì „í™˜
    function switchTab(tab) {
      const marginBtn = document.getElementById('tabMargin');
      const inventoryBtn = document.getElementById('tabInventory');
      const marginSection = document.getElementById('sectionMargin');
      const inventorySection = document.getElementById('sectionInventory');

      if (tab === 'margin') {
        marginBtn.classList.add('active');
        inventoryBtn.classList.remove('active');
        marginSection.style.display = 'block';
        inventorySection.style.display = 'none';
      } else {
        marginBtn.classList.remove('active');
        inventoryBtn.classList.add('active');
        marginSection.style.display = 'none';
        inventorySection.style.display = 'block';
      }

      localStorage.setItem('activeTab', tab);
    }

    // ë¬¼í’ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    function loadInventory() {
      try {
        const saved = localStorage.getItem('inventory');
        if (saved) {
          inventory = JSON.parse(saved);
          renderItemList();
        }
      } catch (e) {
        console.error('Failed to load inventory:', e);
      }
    }

    // ë¬¼í’ˆ ë°ì´í„° ì €ì¥
    function saveInventory() {
      try {
        localStorage.setItem('inventory', JSON.stringify(inventory));
      } catch (e) {
        console.error('Failed to save inventory:', e);
        toast('ì €ì¥ ì‹¤íŒ¨: ìš©ëŸ‰ ì´ˆê³¼');
      }
    }

    // ìœ í†µê¸°í•œ ìƒíƒœ ê³„ì‚°
    function getExpiryStatus(expiryDate) {
      if (!expiryDate) return { class: 'expiry-ok', text: 'ë¯¸ì„¤ì •', dday: null };

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const expiry = new Date(expiryDate);
      expiry.setHours(0, 0, 0, 0);

      const diffTime = expiry - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays < 0) {
        return { class: 'expiry-expired', text: `ë§Œë£Œë¨ (${Math.abs(diffDays)}ì¼ ì „)`, dday: diffDays };
      } else if (diffDays === 0) {
        return { class: 'expiry-expired', text: 'ì˜¤ëŠ˜ ë§Œë£Œ', dday: 0 };
      } else if (diffDays <= 7) {
        return { class: 'expiry-warning', text: `D-${diffDays}`, dday: diffDays };
      } else if (diffDays <= 30) {
        return { class: 'expiry-caution', text: `D-${diffDays}`, dday: diffDays };
      } else {
        return { class: 'expiry-ok', text: `D-${diffDays}`, dday: diffDays };
      }
    }

    // ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸
    function highlightText(text, searchTerm) {
      if (!searchTerm) return escapeHtml(text);
      const escaped = escapeHtml(text);
      const searchEscaped = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(`(${searchEscaped})`, 'gi');
      return escaped.replace(regex, '<span class="highlight">$1</span>');
    }

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      toast('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘...');

      // ì´ë¯¸ì§€ ì••ì¶• ë° ë¦¬ì‚¬ì´ì§• (iOS í˜¸í™˜ì„±)
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          // ìº”ë²„ìŠ¤ë¡œ ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• ë° ì••ì¶•
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          // ìµœëŒ€ í¬ê¸° ì„¤ì • (800px)
          let width = img.width;
          let height = img.height;
          const maxSize = 800;

          if (width > height && width > maxSize) {
            height = (height * maxSize) / width;
            width = maxSize;
          } else if (height > maxSize) {
            width = (width * maxSize) / height;
            height = maxSize;
          }

          canvas.width = width;
          canvas.height = height;

          // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
          ctx.drawImage(img, 0, 0, width, height);

          // Base64ë¡œ ë³€í™˜ (í’ˆì§ˆ 0.7ë¡œ ì••ì¶•)
          try {
            currentImageData = canvas.toDataURL('image/jpeg', 0.7);

            // í¬ê¸° ì²´í¬ (1MB ì œí•œ)
            const sizeInMB = (currentImageData.length * 3) / 4 / 1024 / 1024;
            if (sizeInMB > 1) {
              // ë” ì••ì¶•
              currentImageData = canvas.toDataURL('image/jpeg', 0.5);
            }

            updateImagePreview(currentImageData);
            toast('ì‚¬ì§„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
          } catch (err) {
            console.error('Image conversion error:', err);
            toast('ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹¤íŒ¨. ë‹¤ë¥¸ ì‚¬ì§„ì„ ì‹œë„í•´ì£¼ì„¸ìš”.');
          }
        };

        img.onerror = function() {
          toast('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');
        };

        img.src = e.target.result;
      };

      reader.onerror = function() {
        toast('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨');
      };

      reader.readAsDataURL(file);
    }

    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    function updateImagePreview(imageData) {
      const preview = document.getElementById('imagePreview');
      if (imageData) {
        preview.innerHTML = `
          <img src="${imageData}" alt="ìƒí’ˆ ì‚¬ì§„" />
          <button class="image-remove" onclick="removeImage(event)">Ã—</button>
        `;
      } else {
        preview.innerHTML = `
          <div class="image-preview-placeholder">
            ğŸ“·<br>ì‚¬ì§„ ì¶”ê°€<br>
            <span style="font-size: 0.75rem;">í´ë¦­í•˜ì—¬ ì´¬ì˜ ë˜ëŠ” ì„ íƒ</span>
          </div>
        `;
      }
    }

    // ì´ë¯¸ì§€ ì œê±°
    function removeImage(event) {
      event.stopPropagation();
      currentImageData = null;
      document.getElementById('invImageCamera').value = '';
      document.getElementById('invImageGallery').value = '';
      updateImagePreview(null);
      toast('ì‚¬ì§„ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // ì¹´ë©”ë¼ ì—´ê¸°
    function openCamera() {
      document.getElementById('invImageCamera').click();
    }

    // ê°¤ëŸ¬ë¦¬ ì—´ê¸°
    function openGallery() {
      document.getElementById('invImageGallery').click();
    }

    // ì¹´í…Œê³ ë¦¬ í•„í„° ë Œë”ë§
    function renderCategoryFilter() {
      const categories = [...new Set(inventory.map(item => item.category).filter(Boolean))];
      const filterEl = document.getElementById('categoryFilter');

      let html = '<div class="category-chip active" data-category="" onclick="filterByCategory(\'\')">ì „ì²´</div>';
      categories.forEach(cat => {
        html += `<div class="category-chip" data-category="${cat}" onclick="filterByCategory('${cat}')">${cat}</div>`;
      });

      filterEl.innerHTML = html;
    }

    // ì¹´í…Œê³ ë¦¬ë¡œ í•„í„°ë§
    function filterByCategory(category) {
      currentCategoryFilter = category;

      // ì¹© í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.category-chip').forEach(chip => {
        if (chip.dataset.category === category) {
          chip.classList.add('active');
        } else {
          chip.classList.remove('active');
        }
      });

      // ê²€ìƒ‰ì–´ë„ í•¨ê»˜ ì ìš©
      searchItems();
    }

    // ë¬¼í’ˆ ëª©ë¡ ë Œë”ë§
    function renderItemList(filteredItems = null) {
      const listEl = document.getElementById('itemList');
      const countEl = document.getElementById('itemCount');

      const items = filteredItems !== null ? filteredItems : inventory;

      if (inventory.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            ë“±ë¡ëœ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>
            <span class="muted" style="font-size: .85rem;">ìœ„ì—ì„œ ìƒˆ ë¬¼í’ˆì„ ë“±ë¡í•´ë³´ì„¸ìš”.</span>
          </div>
        `;
        countEl.textContent = '0ê°œ';
        return;
      }

      if (items.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
            <span class="muted" style="font-size: .85rem;">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.</span>
          </div>
        `;
        countEl.textContent = `0ê°œ / ì „ì²´ ${inventory.length}ê°œ`;
        return;
      }

      // ìœ í†µê¸°í•œ ì„ë°•ìˆœìœ¼ë¡œ ì •ë ¬
      const sorted = [...items].sort((a, b) => {
        const statusA = getExpiryStatus(a.expiryDate);
        const statusB = getExpiryStatus(b.expiryDate);
        if (statusA.dday === null) return 1;
        if (statusB.dday === null) return -1;
        return statusA.dday - statusB.dday;
      });

      listEl.innerHTML = sorted.map(item => {
        const status = getExpiryStatus(item.expiryDate);
        return `
          <div class="item-card">
            <div style="display: flex; gap: 12px;">
              ${item.image ? `<img src="${item.image}" class="item-image" alt="${escapeHtml(item.name)}" />` : ''}
              <div style="flex: 1;">
                <div class="item-header">
                  <div>
                    <div class="item-name">${highlightText(item.name, currentSearchTerm)}</div>
                    <div class="item-barcode">${highlightText(item.barcode, currentSearchTerm)}</div>
                    ${item.category ? `<span class="category-badge">${item.category}</span>` : ''}
                  </div>
                  <div class="expiry-badge ${status.class}">${status.text}</div>
                </div>
                <div class="item-detail">
              <div>
                <div class="muted">ìˆ˜ëŸ‰</div>
                <div style="font-weight: 600;">${item.quantity}ê°œ</div>
              </div>
              ${item.price ? `
                <div>
                  <div class="muted">ê°€ê²©</div>
                  <div style="font-weight: 600;">â‚©${formatKRW(item.price)}</div>
                </div>
              ` : ''}
              ${item.memo ? `
                <div style="flex: 2;">
                  <div class="muted">ë©”ëª¨</div>
                  <div style="font-size: .9rem;">${escapeHtml(item.memo)}</div>
                </div>
              ` : ''}
                </div>
                <div class="item-actions">
                  <button class="btn small ghost" onclick="updateQuantity('${item.id}', -1)">-1</button>
                  <button class="btn small ghost" onclick="updateQuantity('${item.id}', 1)">+1</button>
                  <button class="btn small ghost" style="flex: 1;" onclick="deleteItem('${item.id}')">ì‚­ì œ</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      if (filteredItems !== null && filteredItems.length < inventory.length) {
        countEl.textContent = `${items.length}ê°œ / ì „ì²´ ${inventory.length}ê°œ`;
      } else {
        countEl.textContent = `${inventory.length}ê°œ`;
      }
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // ë¬¼í’ˆ ì¶”ê°€
    function addItem() {
      const barcode = document.getElementById('invBarcode').value.trim();
      const name = document.getElementById('invName').value.trim();
      const expiryDate = document.getElementById('invExpiry').value;
      const quantity = parseInt(document.getElementById('invQuantity').value, 10);
      const category = document.getElementById('invCategory').value;
      const price = parseFloat(document.getElementById('invPrice').value) || null;
      const memo = document.getElementById('invMemo').value.trim();

      // ìœ íš¨ì„± ê²€ì‚¬
      if (!barcode) {
        toast('ë°”ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      if (!name) {
        toast('ë¬¼í’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      if (!quantity || quantity < 1) {
        toast('ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      // ê¸°ì¡´ ë¬¼í’ˆ í™•ì¸
      const existing = inventory.find(item => item.barcode === barcode);
      if (existing) {
        if (confirm(`ì´ë¯¸ ë“±ë¡ëœ ë°”ì½”ë“œì…ë‹ˆë‹¤.\n"${existing.name}" ìˆ˜ëŸ‰ì„ ${quantity}ê°œ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          existing.quantity += quantity;
          saveInventory();
          renderItemList();
          toast(`ìˆ˜ëŸ‰ ì¶”ê°€ë¨: ${existing.name} (${existing.quantity}ê°œ)`);
          clearForm();
        }
        return;
      }

      // ìƒˆ ë¬¼í’ˆ ì¶”ê°€
      const newItem = {
        id: Date.now().toString(),
        barcode,
        name,
        category: category || null,
        expiryDate: expiryDate || null,
        quantity,
        price,
        memo,
        image: currentImageData || null,
        registeredAt: new Date().toISOString()
      };

      inventory.push(newItem);
      saveInventory();
      renderItemList();
      renderCategoryFilter();
      toast(`ë¬¼í’ˆ ë“±ë¡ ì™„ë£Œ: ${name}`);
      clearForm();
    }

    // í¼ ì´ˆê¸°í™”
    function clearForm() {
      document.getElementById('invBarcode').value = '';
      document.getElementById('invName').value = '';
      document.getElementById('invExpiry').value = '';
      document.getElementById('invQuantity').value = '1';
      document.getElementById('invCategory').value = '';
      document.getElementById('invPrice').value = '';
      document.getElementById('invMemo').value = '';
      document.getElementById('invImageCamera').value = '';
      document.getElementById('invImageGallery').value = '';
      currentImageData = null;
      updateImagePreview(null);
      document.getElementById('invBarcode').focus();
    }

    // ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
    function updateQuantity(id, delta) {
      const item = inventory.find(i => i.id === id);
      if (!item) return;

      item.quantity += delta;
      if (item.quantity < 0) item.quantity = 0;

      if (item.quantity === 0) {
        if (confirm(`${item.name}ì˜ ìˆ˜ëŸ‰ì´ 0ê°œê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.\në¬¼í’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          deleteItem(id);
          return;
        } else {
          item.quantity = 1;
        }
      }

      saveInventory();
      renderItemList();
      toast(`ìˆ˜ëŸ‰ ë³€ê²½: ${item.name} (${item.quantity}ê°œ)`);
    }

    // ë¬¼í’ˆ ì‚­ì œ
    function deleteItem(id) {
      const item = inventory.find(i => i.id === id);
      if (!item) return;

      if (confirm(`"${item.name}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        inventory = inventory.filter(i => i.id !== id);
        saveInventory();
        renderItemList();
        toast('ë¬¼í’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    // ë°”ì½”ë“œ ìŠ¤ìºë„ˆ í† ê¸€
    function toggleScanner() {
      const container = document.getElementById('scanner-container');
      const btn = document.getElementById('scanBtn');
      const statusEl = document.getElementById('scannerStatus');

      if (isScanning) {
        // ìŠ¤ìºë„ˆ ì¤‘ì§€
        stopScanner();
      } else {
        // ìŠ¤ìºë„ˆ ì‹œì‘
        container.classList.add('active');
        btn.textContent = 'â¹ï¸ ìŠ¤ìº” ì¤‘ì§€';
        statusEl.textContent = 'ì¹´ë©”ë¼ë¥¼ ë°”ì½”ë“œì— ë§ì¶°ì£¼ì„¸ìš”';
        startScanner();
      }
    }

    // ìŠ¤ìºë„ˆ ì‹œì‘
    function startScanner() {
      if (isScanning) return;

      const statusEl = document.getElementById('scannerStatus');

      try {
        if (!html5QrCode) {
          html5QrCode = new Html5Qrcode("reader");
        }

        const config = {
          fps: 10,
          qrbox: { width: 250, height: 150 },
          aspectRatio: 1.0,
          formatsToSupport: [
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E,
            Html5QrcodeSupportedFormats.QR_CODE
          ]
        };

        html5QrCode.start(
          { facingMode: "environment" },
          config,
          onScanSuccess,
          onScanError
        ).then(() => {
          isScanning = true;
          statusEl.textContent = 'ìŠ¤ìº” ì¤‘... ë°”ì½”ë“œë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”';
        }).catch(err => {
          console.error('Failed to start scanner:', err);
          statusEl.textContent = 'ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
          toast('ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤');
          stopScanner();
        });
      } catch (err) {
        console.error('Scanner error:', err);
        toast('ìŠ¤ìºë„ˆ ì´ˆê¸°í™” ì‹¤íŒ¨');
        stopScanner();
      }
    }

    // ìŠ¤ìºë„ˆ ì¤‘ì§€
    function stopScanner() {
      const container = document.getElementById('scanner-container');
      const btn = document.getElementById('scanBtn');

      if (html5QrCode && isScanning) {
        html5QrCode.stop().then(() => {
          isScanning = false;
          container.classList.remove('active');
          btn.textContent = 'ğŸ“· ì¹´ë©”ë¼ë¡œ ë°”ì½”ë“œ ìŠ¤ìº”';
        }).catch(err => {
          console.error('Failed to stop scanner:', err);
          isScanning = false;
          container.classList.remove('active');
          btn.textContent = 'ğŸ“· ì¹´ë©”ë¼ë¡œ ë°”ì½”ë“œ ìŠ¤ìº”';
        });
      } else {
        isScanning = false;
        container.classList.remove('active');
        btn.textContent = 'ğŸ“· ì¹´ë©”ë¼ë¡œ ë°”ì½”ë“œ ìŠ¤ìº”';
      }
    }

    // ìŠ¤ìº” ì„±ê³µ ì½œë°±
    function onScanSuccess(decodedText, decodedResult) {
      const statusEl = document.getElementById('scannerStatus');
      const barcodeInput = document.getElementById('invBarcode');

      // ë°”ì½”ë“œ ì…ë ¥ í•„ë“œì— ê°’ ì„¤ì •
      barcodeInput.value = decodedText;

      // ì„±ê³µ ë©”ì‹œì§€
      statusEl.textContent = `âœ… ìŠ¤ìº” ì™„ë£Œ: ${decodedText}`;
      toast(`ë°”ì½”ë“œ ìŠ¤ìº” ì™„ë£Œ: ${decodedText}`);

      // ë¬¼í’ˆëª… í•„ë“œë¡œ í¬ì»¤ìŠ¤ ì´ë™
      document.getElementById('invName').focus();

      // 2ì´ˆ í›„ ìŠ¤ìºë„ˆ ìë™ ì¤‘ì§€
      setTimeout(() => {
        stopScanner();
      }, 2000);
    }

    // ìŠ¤ìº” ì—ëŸ¬ ì½œë°± (ì—ëŸ¬ê°€ ì•„ë‹Œ ìŠ¤ìº” ì§„í–‰ ì¤‘ ìƒíƒœ)
    function onScanError(errorMessage) {
      // ìŠ¤ìº” ì¤‘ì—ëŠ” ê³„ì† ì—ëŸ¬ê°€ ë°œìƒí•˜ë¯€ë¡œ ë¬´ì‹œ
      // console.log('Scanning...', errorMessage);
    }

    // ë¬¼í’ˆ ê²€ìƒ‰ ê¸°ëŠ¥
    function searchItems() {
      const searchInput = document.getElementById('searchInput');
      const searchTerm = searchInput.value.trim().toLowerCase();
      currentSearchTerm = searchInput.value.trim();

      let filtered = inventory;

      // ì¹´í…Œê³ ë¦¬ í•„í„° ì ìš©
      if (currentCategoryFilter) {
        filtered = filtered.filter(item => item.category === currentCategoryFilter);
      }

      // ê²€ìƒ‰ì–´ í•„í„° ì ìš©
      if (searchTerm) {
        filtered = filtered.filter(item => {
          const nameMatch = item.name.toLowerCase().includes(searchTerm);
          const barcodeMatch = item.barcode.toLowerCase().includes(searchTerm);
          return nameMatch || barcodeMatch;
        });
      }

      renderItemList(filtered);

      // ê²€ìƒ‰ ê²°ê³¼ í”¼ë“œë°±
      if (searchTerm || currentCategoryFilter) {
        if (filtered.length === 0) {
          // ê²°ê³¼ ì—†ìŒì€ renderItemListì—ì„œ ì²˜ë¦¬
        } else if (filtered.length === 1) {
          toast(`1ê°œ ë¬¼í’ˆ ë°œê²¬`);
        } else {
          toast(`${filtered.length}ê°œ ë¬¼í’ˆ ë°œê²¬`);
        }
      }
    }

    // ë°”ì½”ë“œë¡œ ë¬¼í’ˆ ì°¾ê¸° (ë‹¨ì¼ ê²°ê³¼)
    function findItemByBarcode(barcode) {
      return inventory.find(item => item.barcode === barcode);
    }

    // ì´ˆê¸°í™”
    (function initInventory() {
      loadInventory();
      renderCategoryFilter();

      // ì €ì¥ëœ íƒ­ ë³µì›
      const savedTab = localStorage.getItem('activeTab');
      if (savedTab === 'inventory') {
        switchTab('inventory');
      }

      // íƒ­ ì „í™˜ ì‹œ ìŠ¤ìºë„ˆ ì¤‘ì§€
      const originalSwitchTab = switchTab;
      switchTab = function(tab) {
        if (isScanning && tab !== 'inventory') {
          stopScanner();
        }
        originalSwitchTab(tab);
      };
    })();
  </script>
</body>
</html>